
name: Deploy tolenaar-toto
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    # This tells GitHub to use your NAS container instead of a GitHub-owned server
    runs-on: self-hosted 
    steps:
      - name: Fix Git Permissions
        run: git config --global --add safe.directory /volume1/docker/tolenaar-toto

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Deploy
        run: |
          cd /volume1/docker/tolenaar-toto

          # 1. Stop and remove the old containers and volumes
          docker compose down --volumes --remove-orphans

          # 2. Delete the old image so the runner is forced to build it fresh
          docker image rm tolenaar-toto-prod-frontend:latest --force || true

          # 3. Build from scratch without using any cache
          docker compose build --no-cache

          # 4. Start the new container
          docker compose up -d --force-recreate